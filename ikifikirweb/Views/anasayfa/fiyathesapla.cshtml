@model ikifikirweb.ViewModels.PricingDataModelWeb.PricingWebModel.PricingViewModel
@using ikifikirweb.ViewModels.PricingDataModelWeb.PricingComponentWebModel
@using ikifikirweb.ViewModels.PricingDataModelWeb.PricingComponentTypeWebModel
@using ikifikirweb.ViewModels.PricingDataModelWeb.PricingWebModel
@using ikifikir.CORE.EmailConfig
@{
    ViewData["Title"] = "fiyathesapla";
    Layout = "~/Views/Shared/_Layout.cshtml";

    List<PricingComponentTypeListViewModel> types = ViewBag.Tipler as List<PricingComponentTypeListViewModel>;
    List<PricingComponentListViewModel> components = ViewBag.Bilesenler as List<PricingComponentListViewModel>;
    List<PricingListViewModel> pricingList = ViewBag.Paketler as List<PricingListViewModel>;
    List<ComponentResult> componentChoosed = ViewBag.ComponentChoosed as List<ComponentResult>;

    string[] nameList = { };
    List<string> stringArray = new List<string>();
    string titleCurrent = "";

    if (componentChoosed != null)
    {
        foreach (var item in componentChoosed)
        {
            stringArray.Add(item.Title);
        }
        nameList = stringArray.ToArray();
    }

    int total = Convert.ToInt32(ViewBag.Total);

}
<link href="~/assets/css/mobile.css" rel="stylesheet" />
<link href="~/assets/css/calculate.css" rel="stylesheet" />

<section id="prices-section">
    <div class="prices-section-inner tt-wrap">
        <div class="price-boxes-container">

            <div class="row price-pb-m">
                <div class="col-sm-12">
                    <div class="tt-heading tt-heading-xlg padding-on" style="position: relative; top: 15px;">
                        <div class="tt-heading-inner">
                            <h1 class="tt-heading-title">@Model.Title</h1>
                            <div class="tt-heading-subtitle">Lütfen fiyat hesaplama modulünden istediğiniz hizmetleri seçin</div>
                        </div> <!-- /.tt-heading-inner -->
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-9" id="col-pb-mobile">
                    <div class="row">
                        @foreach (var item in components)
                        {
                            <div class="col-xs-12 col-sm-6 col-md-6 col-lg-3" style="padding-right: 5px;">
                                <div class="price-box">
                                    <div class="pr-box price-heading">
                                        <div class="price-heading-inner">
                                            <div class="prh-icon"><span class="lnr lnr-layers"></span></div>
                                            <h3 class="price-title">@item.ComponentTitle</h3>
                                        </div>
                                    </div>
                                    <div class="pr-box price-features">
                                        <ul class="list-unstyled">
                                            <li>@*@Decimal.Parse(item.Price.ToString("0.00##"))*@ @Convert.ToInt32(item.Price) ₺</li>
                                        </ul>
                                    </div>
                                    <div class="pr-box">

                                        @if (nameList != null && nameList.Length > 0)
                                        {
                                            foreach (var item2 in nameList)
                                            {
                                                if (item.ComponentTitle == item2)
                                                {
                                                    titleCurrent = item.ComponentTitle;
                                                }
                                            }
                                        }

                                        @if (item.ComponentTitle == titleCurrent)
                                        {
                                            <button style="padding: 5px 25px; font-size: 15px;" value="@item.Id" class="btn btn-price-box btn-primary active">Seçildi</button>
                                            <input type="hidden" value="@item.Price" id="price_@item.Id" />
                                        }

                                        else
                                        {
                                            <button style="padding: 5px 25px; font-size: 15px;" value="@item.Id" class="btn btn-price-box btn-primary">Seç</button>
                                            <input type="hidden" value="@item.Price" id="price_@item.Id" />
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
                <div class="col-sm-3 fixed-total" style="padding-right: 5px;">
                    <div class="pay-box">

                        @if (componentChoosed != null)
                        {
                            <div class="price-box overflow-y-scroll" style="max-height:272px;">
                                <div class="pr-box price-features" style="padding: 5px 10px 0px 10px;">
                                    <ul class="list-unstyled">
                                        @foreach (var item in componentChoosed)
                                        {
                                            <li style="font-size: 15px; line-height: 22px;">@item.Title</li>
                                            <li><strong>@item.Price ₺</strong></li>
                                            <hr style=" margin-top: 10px; margin-bottom: 10px;" />
                                        }
                                    </ul>
                                </div>
                            </div>
                        }
                        <div class="price-box pr-box-featured" id="btn-width">
                            <div class="pr-box price-box-price">
                                @if (total > 0)
                                {
                                    <div class="price"><span id="count-price">@total</span> ₺</div>
                                }
                                else
                                {
                                    <div class="price"><span id="count-price">0</span> ₺</div>
                                }
                            </div>
                        </div>
                        @if (total > 0)
                        {
                            <a onclick="confirmCalculate();" style="background: none; border: 0; width: 100%; padding: 0;" class="btn-left" id="btn-width">
                                <div class="price-box pr-box-featured" id="btnNext">
                                    <div class="pr-box price-box-price btn-padding" style="padding: 7px 20px 15px 35px;">
                                        <div class="price"><span>Sepete Git</span></div>
                                    </div>
                                </div>
                            </a>
                        }
                        else
                        {
                            <a onclick="confirmCalculate();" style="background: none; border: 0; width: 100%; padding: 0;" class="btn-left" id="btn-width">
                                <div class="price-box pr-box-featured" id="btnNext">
                                    <div class="pr-box price-box-price btn-padding" style="padding: 7px 20px 15px 35px;">
                                        <div class="price"><span>Sepete Ekle</span></div>
                                    </div>
                                </div>
                            </a>
                        }

                    </div>


                </div>

            </div>
            <div class="row">
                <div class="col-sm-12" style="max-width:85%;">
                    <div class="portfolio-list-inner isotope-wrap tt-wrap">

                        <div class="isotope col-3 gutter-3">

                            <div class="isotope-top-content">

                                <div class="isotope-filter">
                                    <div class="isotope-filter-button">
                                        <span class="ifb-icon"><span class="lnr lnr-funnel"></span></span>
                                        <span class="ifb-icon-close"><i class="fas fa-times"></i></span>

                                        <span class="ifb-text">Filter</span>

                                    </div>

                                    <span class="margin-bottom-2-p"><strong>Bu hizmetlerimize de göz atmak ister misiniz?</strong></span>

                                    <ul class="isotope-filter-links" style="margin-top:10px;">

                                        @foreach (var item in pricingList)
                                        {
                                            if (item.Id != Model.Id)
                                            {
                                                <li><button onclick="window.location.href='@Url.Action("fiyathesapla", "anasayfa", new { Id = item.Id })'" data-filter=".branding">+ @item.Title</button></li>
                                            }

                                        }

                                    </ul>

                                </div>

                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script src="~/assets/vendor/jquery/jquery.min.js"></script>

<script type="text/javascript">

    let buttons = document.querySelectorAll('button');
    const countPrice = document.getElementById("count-price");
    const btnNext = document.getElementById("btnNext");
    let totalPrice = 0;
    let sumTotal = 0;

    var IdS = [];
    var IdsRemove = [];

    if (@total > 0) {
        sumTotal = @total;
        btnNext.style.cursor = "pointer";
        btnNext.style.backgroundColor = "#0040d8";
    }
    else {
        btnNext.style.cursor = "not-allowed";
        btnNext.style.backgroundColor = "#84a8ff";
        btnNext.style.disabled = "disabled";
    }

    buttons.forEach(button => {
        button.addEventListener('click', function () {
            btnNext.style.cursor = "pointer";
            btnNext.style.backgroundColor = "#0040d8";
            btnNext.style.disabled = "false";

            if (this.innerHTML == "Seç") {
                var id = $(this).val();
                IdS.push($(this).val());
                selected = true;
                this.classList.add('active');
                this.innerHTML = "Seçildi";
                totalPrice = Number.parseInt($("#price_" + id).val());
                countPrice.innerHTML = increment(totalPrice);
            }
            else if (this.innerHTML == "Seçildi") {
                var id = $(this).val();
                IdsRemove.push($(this).val());
                selected = false;
                this.classList.remove('active');
                this.innerHTML = "Seç";
                totalPrice = Number.parseInt($("#price_" + id).val());
                countPrice.innerHTML = deIncrement(totalPrice);
            }
        });
    });

    function increment(totalPriceValue) {
        sumTotal += totalPriceValue;
        return Number.parseInt(sumTotal);
    }

    function deIncrement(totalPriceDeValue) {
        sumTotal -= totalPriceDeValue;
        return Number.parseInt(sumTotal);
    }

</script>

<script>

    var confirmCalculate = function () {

         try {

            $.ajax({

               type: "POST",
               url: "/anasayfa/secimiOnayla/",
               data: { Ids: IdS, IdsRemove: IdsRemove },
               success: function (response) {
                    console.log("deneme");
                   window.location.href = "@Url.Action("fiyatOnayla","anasayfa")";
               },
               error: function (response) {
                    console.log("hata");
               }

            });
         }

         catch (err) {
             alert(err);
         }

         finally {

         }

    }

</script>
